

<h1 class="phoneTitle">{%label.phWDSTitle%}</h1><script type="text/javascript">var PWD_ERROR=3,SIGNAL_WEAK=4,WDS_FAIL=5,DHCP_FAIL=6,WDS_CONNECT_FAIL=7,WDS_TIMEOUT=8,getDhcpsHd=null,getDhcpcHd=null,getWdsStatusHd=null,gLanIPStatus=!1,isLanIpChanged=!1,bInWizard=!0,backFromNextPage=!1,failRetry=!1,scanList=[];
function errHandle(b){switch(b){case ENONE:return!0;case EINVSSIDEMPTY:showPhWzdAlert(errStr.wlanSsidErr);break;case EINVSSIDLEN:showPhWzdAlert(errStr.wlanSsidLenErr);break;case EINVSSIDBLANK:showPhWzdAlert(errStr.wlanSsidBlank);break;case EINVPSKLEN:showPhWzdAlert(errStr.wlanPwdLenValid);break;case EINVIPFMT:showPhWzdAlert(errStr.ipAddrFmtNoteErr);break;case EINVNET:showPhWzdAlert(errStr.stcIpNetErr);break;case EINVIP:showPhWzdAlert(errStr.lanIpErr);break;case EINVNETID:showPhWzdAlert(errStr.stcNetIdErr);
break;case EINVGROUPIP:showPhWzdAlert(errStr.ipAddrGroupErr);break;case EINVLOOPIP:showPhWzdAlert(errStr.ipAddrLoopErr);break;case EINVHOSTID:showPhWzdAlert(errStr.wdsIpAddrHostIdErr);break;case ECOMFLICTNET:showPhWzdAlert(errStr.lanIpWanConflict);break;case EINVWLANPWD:showPhWzdAlert(errStr.wlanPwdInvalid);break;case ESYSBUSY:showPhWzdAlert(errStr.invRequestFailTrylater);break;default:showPhWzdAlert(errStr.invRequestFail)}return!1}
var MANUAL_WDS=!1,bWirelessLinked=!1,gOldLanIP="",gLanIP="",gLanIPMode="",FREQ_2G=0,FREQ_5G=1,FREQ_5G1=2,FREQ_5G4=3,FREQ_BS=4,oldSelFreq={},wdsTargetSelFreq={},gWDSSuccessList=[],gWDSPwdErrList=[],gWDSFailStatus,gWDSFailStr,gWDSPartlyFailStr,curEqtFreq=FREQ_2G,gFreqInfo=["2.4G","5G","5G1","5G2"],gLocalAPInfo=[];gLocalAPInfo[FREQ_2G]={ssid:"",encryption:"",key:"",enable:""};gLocalAPInfo[FREQ_5G]={ssid:"",encryption:"",key:"",enable:""};gLocalAPInfo[FREQ_5G1]={ssid:"",encryption:"",key:"",enable:""};
gLocalAPInfo[FREQ_5G4]={ssid:"",encryption:"",key:"",enable:""};gLocalAPInfo[FREQ_BS]={ssid:"",encryption:"",key:"",wifi_enable:"",bs_enable:""};var gRootAPInfo=[];gRootAPInfo[FREQ_2G]={ssid:"",encryption:"",key:"",enable:""};gRootAPInfo[FREQ_5G]={ssid:"",encryption:"",key:"",enable:""};gRootAPInfo[FREQ_5G1]={ssid:"",encryption:"",key:"",enable:""};gRootAPInfo[FREQ_5G4]={ssid:"",encryption:"",key:"",enable:""};var connectingCount=1,dhcpcRetryCounts=1,dhcpsRetryCounts=1,gWDSModel=[];
gWDSModel[FREQ_2G]={start_dhcps_detect:"start_dhcps_detect_2g",wds_start:"wds_start_2g",wlan_wds_dhcps:"wlan_wds_2g_dhcps",wlan_wds_dhcpc:"wlan_wds_2g_dhcpc",wlan_wds_status:"wlan_wds_2g_status",set_wds:"wlan_wds_2g",scan_start:{wireless:{scan_start_2g:null}},wlan_scan_status:"wlan_scan_2g_status",wlan_scan:"wlan_scan_2g"};
gWDSModel[FREQ_5G]={start_dhcps_detect:"start_dhcps_detect_5g",wds_start:"wds_start_5g",wlan_wds_dhcps:"wlan_wds_5g_dhcps",wlan_wds_dhcpc:"wlan_wds_5g_dhcpc",wlan_wds_status:"wlan_wds_5g_status",set_wds:"wlan_wds_5g",scan_start:{wireless:{scan_start_5g:null}},wlan_scan_status:"wlan_scan_5g_status",wlan_scan:"wlan_scan_5g"};
gWDSModel[FREQ_5G1]={start_dhcps_detect:"start_dhcps_detect_5g_1",wds_start:"wds_start_5g_1",wlan_wds_dhcps:"wlan_wds_5g_1_dhcps",wlan_wds_dhcpc:"wlan_wds_5g_1_dhcpc",wlan_wds_status:"wlan_wds_5g_1_status",set_wds:"wlan_wds_5g_1",scan_start:{wireless:{scan_start_5g_1:null}},wlan_scan_status:"wlan_scan_5g1_status",wlan_scan:"wlan_scan_5g_1"};
gWDSModel[FREQ_5G4]={start_dhcps_detect:"start_dhcps_detect_5g_4",wds_start:"wds_start_5g_4",wlan_wds_dhcps:"wlan_wds_5g_4_dhcps",wlan_wds_dhcpc:"wlan_wds_5g_4_dhcpc",wlan_wds_status:"wlan_wds_5g_4_status",set_wds:"wlan_wds_5g_4",scan_start:{wireless:{scan_start_5g_4:null}},wlan_scan_status:"wlan_scan_5g4_status",wlan_scan:"wlan_scan_5g_4"};
function checkWifiSwitchOff(b){var a="custom_wireless",d={};"undefined"!=typeof gWifiSwitchUseWireless&&gWifiSwitchUseWireless&&(a="wireless");d[a]={};d[a].name="wifi_switch";$.query(d,function(d){d.error_code!==ENONE?errHandle(d.error_code):"off"==d[a].wifi_switch.enable?showPhWzdAlert("无线总开关已关闭，请先开启无线总开关后再重新设置。",function(){loadPage("PhoneNetwork.htm","phCon")}):b()})}
function dhcpFailConfirm(){gWDSFailStatus=DHCP_FAIL;connectingCount=dhcpsRetryCounts=dhcpcRetryCounts=1;loadPage("PhoneWlanWDSCfgFail.htm","phCon")}function dhcpFailHandle(){closeLoading();gWifiSwitchSupport||gCustomWifiSwitchSupport?checkWifiSwitchOff(dhcpFailConfirm):dhcpFailConfirm()}
function lanIpModeHandle(b){"manual"==gLanIPMode?showPhConfirm("当前路由器的LAN口IP为手动设置，使用无线桥接将更改为自动，确定更改LAN口IP设置？",function(a){!0==a&&(gLanIPMode="dynamic",$.modify({network:{lan:{ip_mode:"dynamic"}}},null,!0),b())}):b()}
function wdsCanceldHandle(){var b={wireless:{}},a={wireless:{}},d;for(d in wdsTargetSelFreq)wdsTargetSelFreq[d].selected&&(b.wireless[gWDSModel[d].set_wds]={enable:"0"},a.wireless[gWDSModel[d].wds_start]={set_ip_immediate:"1"},gRootAPInfo[d].enable="0");clearTimeout(getWdsStatusHd);clearTimeout(getDhcpsHd);clearTimeout(getDhcpcHd);$.modify(b,function(){$.action(a,function(a){closeLoading()})})}
function wdsSetLanIp(){$.modify({network:{lan:{ipaddr:gLanIP,netmask:gLanMask,ip_mode:"dynamic"}},system:{sys_mode:{mode:uciSystem.optValue.sysMode.wdsMode}}},function(b){$.action({network:{apply_lan_config:null}});closeLoading();showLoading("连接成功，路由器IP地址已更改为："+gLanIP+"。页面将自动跳转到新的IP地址，请稍候...",void 0,adjustPhLoading(),!1);$.changeDomain(gLanIP);$.setTimeout(function(){window.location.href="http://"+gLanIP},12E4);$.setTimeout(function(){lanDetecting(function(){window.location.href="http://"+gLanIP})},
4E3)})}
function wdsGetIpDhcpsStatus(){var b={wireless:{name:[]}},a;for(a in wdsTargetSelFreq)wdsTargetSelFreq[a].selected&&b.wireless.name.push(gWDSModel[a].wlan_wds_dhcps);15<dhcpsRetryCounts?dhcpFailHandle():$.query(b,function(a){if(ENONE==a[ERR_CODE]){var b=!0,c;for(c in wdsTargetSelFreq)if(wdsTargetSelFreq[c].selected){var f=parseInt(a.wireless[gWDSModel[c].wlan_wds_dhcps].status),h=parseInt(a.wireless[gWDSModel[c].wlan_wds_dhcps].result);if(1==f&&1==h){dhcpcRetryCounts=1;getDhcpcHd=$.setTimeout(wdsDhcpcGetStatus,100);
return}0==f&&(b=!1)}b?dhcpFailHandle():(dhcpsRetryCounts++,getDhcpsHd=$.setTimeout(wdsGetIpDhcpsStatus,1E3))}else dhcpFailHandle()})}
function wdsDhcpcGetStatus(){if(15<dhcpcRetryCounts)dhcpFailHandle();else{var b={wireless:{name:[]}},a;for(a in wdsTargetSelFreq)wdsTargetSelFreq[a].selected&&b.wireless.name.push(gWDSModel[a].wlan_wds_dhcpc);$.query(b,function(a){var b=!0,c;for(c in wdsTargetSelFreq)if(wdsTargetSelFreq[c].selected){var f=a.wireless[gWDSModel[c].wlan_wds_dhcpc];if(uciWireless.dynOptValue.dhcpcStatus.dhcpcSuccess==f.status){closeLoading();gLanIP=f.ip;gLanMask=f.mask;loadPage("PhoneWlanWDSCfgThird.htm","phCon");return}uciWireless.dynOptValue.dhcpcStatus.dhcpcRequsting==
f.status&&(b=!1)}b?dhcpFailHandle():(dhcpcRetryCounts++,getDhcpcHd=$.setTimeout(wdsDhcpcGetStatus,1E3))})}}function wdsFailComfirm(){gWDSFailStatus=WDS_FAIL;clearTimeout(getWdsStatusHd);connectingCount=1;loadPage("PhoneWlanWDSCfgFail.htm","phCon")}function wdsTimeoutHandle(){function b(){gWDSFailStatus=WDS_TIMEOUT;clearTimeout(getWdsStatusHd);connectingCount=1;loadPage("PhoneWlanWDSCfgFail.htm","phCon")}closeLoading();gWifiSwitchSupport||gCustomWifiSwitchSupport?checkWifiSwitchOff(b):b()}
function wdsStatusHd(){if(20<connectingCount)"undefined"!=typeof wdsTimeoutHandle?wdsTimeoutHandle():(closeLoading(),gWifiSwitchSupport||gCustomWifiSwitchSupport?checkWifiSwitchOff(wdsFailComfirm):wdsFailComfirm());else{var b={wireless:{name:[]}},a;for(a in wdsTargetSelFreq)wdsTargetSelFreq[a].selected&&b.wireless.name.push(gWDSModel[a].wlan_wds_status);$.query(b,function(a){var b=0,c=0,f=0,h=0,n=0,k=0,g="",p="",l="",m="";gWDSPwdErrList=[];gWDSSuccessList=[];for(var e in wdsTargetSelFreq)if(wdsTargetSelFreq[e].selected){var q=
parseInt(a.wireless[gWDSModel[e].wlan_wds_status].status);wdsTargetSelFreq[e].status=q;switch(q){case 2:c++;g+=(""==g?"":",")+gFreqInfo[e]+"频段"+gRootAPInfo[e].ssid;gWDSSuccessList.push(gRootAPInfo[e]);break;case 3:f++;gRootAPInfo[e].pwdErr=!0;p+=(""==p?"":",")+gFreqInfo[e]+"频段"+gRootAPInfo[e].ssid;gWDSPwdErrList.push(e);break;case 4:h++;l+=(""==l?"":",")+gFreqInfo[e]+"频段"+gRootAPInfo[e].ssid;break;case 5:n++;m+=(""==m?"":",")+gFreqInfo[e]+"频段"+gRootAPInfo[e].ssid;break;case 0:case 1:b++}k++}gWDSFailStatus=
0;c==k?(dhcpsRetryCounts=1,getDhcpsHd=$.setTimeout(wdsGetIpDhcpsStatus,100)):0!=b?(connectingCount++,getWdsStatusHd=$.setTimeout(wdsStatusHd,2E3)):n==k?(closeLoading(),gWDSFailStatus=5,gWDSFailStr="中继失败，请尝试重新配置",loadPage("PhoneWlanWDSCfgFail.htm","phCon")):h==k?(closeLoading(),gWDSFailStatus=4,gWDSFailStr="前端路由信号弱，请尝试重新配置",loadPage("PhoneWlanWDSCfgFail.htm","phCon")):f==k?(closeLoading(),gWDSFailStatus=3,loadPage("PhoneWlanWDSCfgSecond.htm","phCon")):n+h+f==k?(closeLoading(),0<f?(gWDSFailStatus=3,
loadPage("PhoneWlanWDSCfgSecond.htm","phCon")):(gWDSFailStatus=5,gWDSFailStr=l+"信号弱；"+m+"中继失败；请尝试重新配置",loadPage("PhoneWlanWDSCfgFail.htm","phCon"))):0<c&&(0<f?(closeLoading(),gWDSPartlyFailStr=g+"中继成功，"+p+"密码错误；您可重新输入密码或只中继成功的网络"):(a=g+"中继成功，",0<h&&(a+=l+"信号弱；"),0<n&&(a+=m+"中继失败；"),a+="您可尝试重连或只中继成功的网络",closeLoading(),gWDSPartlyFailStr=a),loadPage("PhoneWlanWDSCfgPartlyFail.htm","phCon"))})}}
function adjustPhLoading(){return{loadConClass:"phLoadConClass",loadClass:"phLoadClass",coverLoadingClass:"phCoverLoadingClass"}}
function chkWifiOpened(){if(gSupportBS&&"1"==gLocalAPInfo[FREQ_BS].bs_enable)"1"==gLocalAPInfo[FREQ_BS].wifi_enable?loadPage("PhoneWlanWDSCfgFirst.htm","phCon"):showPhConfirm(label.alertWifiOpen,function(a){!0==a&&openWifi(!0)});else{for(var b in gLocalAPInfo)if("1"==gLocalAPInfo[b].enable){loadPage("PhoneWlanWDSCfgFirst.htm","phCon");return}showPhConfirm(label.alertWifiOpen,function(a){!0==a&&openWifi(!1)})}}
function closeFailedBand(){var b={wireless:{}},a;for(a in wdsTargetSelFreq)wdsTargetSelFreq[a].selected&&2!=wdsTargetSelFreq[a].status&&(b.wireless[gWDSModel[a].set_wds]={enable:"0",ssid:""},gRootAPInfo[a].enable="0",wdsTargetSelFreq[a].selected=!1);$.modify(b,function(a){dhcpsRetryCounts=1;getDhcpsHd=$.setTimeout(wdsGetIpDhcpsStatus,100)})}var gKeyNames=[];gKeyNames[BAND_1]={};gKeyNames[BAND_2]={};gKeyNames[BAND_3]={};gKeyNames[BAND_1].wlan_host=[];gKeyNames[BAND_2].wlan_host=[];
gKeyNames[BAND_3].wlan_host=[];gKeyNames[BAND_1].wlan_wds=[];gKeyNames[BAND_2].wlan_wds=[];gKeyNames[BAND_3].wlan_wds=[];gKeyNames[BAND_1].wds_cfg_status=[];gKeyNames[BAND_2].wds_cfg_status=[];gKeyNames[BAND_3].wds_cfg_status=[];gKeyNames[BAND_1].wlan_host[FREQ_2G]="wlan_host_2g";gKeyNames[BAND_1].wlan_wds[FREQ_2G]="wlan_wds_2g";gKeyNames[BAND_1].wds_cfg_status[FREQ_2G]="wds_cfg_status_2g";gKeyNames[BAND_2].wlan_host[FREQ_2G]="wlan_host_2g";gKeyNames[BAND_2].wlan_host[FREQ_5G]="wlan_host_5g";
gKeyNames[BAND_2].wlan_wds[FREQ_2G]="wlan_wds_2g";gKeyNames[BAND_2].wlan_wds[FREQ_5G]="wlan_wds_5g";gKeyNames[BAND_2].wds_cfg_status[FREQ_2G]="wds_cfg_status_2g";gKeyNames[BAND_2].wds_cfg_status[FREQ_5G]="wds_cfg_status_5g";gKeyNames[BAND_3].wlan_host[FREQ_2G]="wlan_host_2g";gKeyNames[BAND_3].wlan_host[FREQ_5G1]="wlan_host_5g_1";gKeyNames[BAND_3].wlan_host[FREQ_5G4]="wlan_host_5g_4";gKeyNames[BAND_3].wlan_wds[FREQ_2G]="wlan_wds_2g";gKeyNames[BAND_3].wlan_wds[FREQ_5G1]="wlan_wds_5g_1";
gKeyNames[BAND_3].wlan_wds[FREQ_5G4]="wlan_wds_5g_4";gKeyNames[BAND_3].wds_cfg_status[FREQ_2G]="wds_cfg_status_2g";gKeyNames[BAND_3].wds_cfg_status[FREQ_5G1]="wds_cfg_status_5g_1";gKeyNames[BAND_3].wds_cfg_status[FREQ_5G4]="wds_cfg_status_5g_4";
function init(){function b(){var a={wireless:{name:[]},network:{name:["lan"]},hosts_info:{table:["host_info"]}},b;for(b in gKeyNames[gBandNum])$.each(gKeyNames[gBandNum][b],function(b,c){null!=c&&a.wireless.name.push(c)});"undefined"!=typeof gSupportBS&&gSupportBS&&a.wireless.name.push("wlan_bs");$.query(a,function(a){$.each(gKeyNames[gBandNum].wlan_host,function(b,c){null!=c&&(gLocalAPInfo[b].enable=a.wireless[c].enable,gLocalAPInfo[b].ssid=a.wireless[c].ssid,gLocalAPInfo[b].encryption=a.wireless[c].encryption,
gLocalAPInfo[b].key=a.wireless[c].key)});$.each(gKeyNames[gBandNum].wlan_wds,function(b,c){null!=c&&(gRootAPInfo[b].enable=a.wireless[c].enable,gRootAPInfo[b].ssid=a.wireless[c].ssid||"",gRootAPInfo[b].encryption=parseInt(a.wireless[c].encryption)?1:0,gRootAPInfo[b].key=a.wireless[c].key)});gSupportBS&&(gLocalAPInfo[FREQ_BS].wifi_enable=a.wireless.wlan_bs.wifi_enable,gLocalAPInfo[FREQ_BS].bs_enable=a.wireless.wlan_bs.bs_enable,gLocalAPInfo[FREQ_BS].ssid=a.wireless.wlan_bs.ssid,gLocalAPInfo[FREQ_BS].encryption=
a.wireless.wlan_bs.encryption,gLocalAPInfo[FREQ_BS].key=a.wireless.wlan_bs.key);gOldLanIP=gLanIP=a.network.lan.ipaddr;gLanIPMode=a.network.lan.ip_mode;for(var b=uciHostsInfo.optValue.linkType.wired,c=formatTableData(a.hosts_info.host_info),d=c.length,g=0;g<d;g++)if("1"==c[g].is_cur_host){switch(c[g].wifi_mode){case "0":curEqtFreq=FREQ_2G;break;case "1":curEqtFreq=FREQ_5G;break;case "2":curEqtFreq=FREQ_5G1;break;case "3":curEqtFreq=FREQ_5G4}gSupportBS&&"1"==gLocalAPInfo[FREQ_BS].bs_enable&&(curEqtFreq=
FREQ_BS);bWirelessLinked=b!=c[g].type?!0:!1;break}lanIpModeHandle(chkWifiOpened)})}function a(){var a={};a[uciCustomNetwork.fileName]={};a[uciCustomNetwork.fileName][KEY_NAME]=[uciCustomNetwork.dynData.bridgestatus];$.query(a,function(a){a[ERR_CODE]==ENONE?a[uciCustomNetwork.fileName][uciCustomNetwork.dynData.bridgestatus][uciCustomNetwork.optName.enable]==uciCustomNetwork.optValue.mode.bridge?$("#bridgeTip").show():b():errHandle(a[ERR_CODE])})}function d(){var d,c={};d=gWifiSwitchSupport&&gCustomWifiSwitchSupport?
uciWireless.fileName:uciCustomWireless.fileName;c[d]={};c[d].name="wifi_switch";$.query(c,function(c){c[ERR_CODE]!==ENONE?errHandle(result[ERR_CODE]):"off"==c[d].wifi_switch.enable||"off"==c[d].wifi_switch.enable_2g&&"off"==c[d].wifi_switch.enable_5g?id("wifiTip").style.display="block":gModeSwitchSupport?a():b()})}gWifiSwitchSupport||gCustomWifiSwitchSupport?d():gModeSwitchSupport?a():b()}init();
</script><style type="text/css">#WDSCon{margin-top:25px!important}div.WDSBlockFuncA{font-size:0;margin:18px 0;text-align:right;overflow:hidden}div.WDSBlockFuncB{width:413px}#WDSWwitchCon{visibility:hidden}#hsSwitchState{visibility:hidden}p.WDSTitle{color:#fff;font-size:12px;font-weight:bold;text-align:left!important}span.WDSLinkRetrySp{height:17px;line-height:21px;cursor:pointer;display:inline-block;border-bottom:1px solid #fff}p.wifiSwitchOffTip{color:#fff;margin:32px 24px;text-align:left}</style>
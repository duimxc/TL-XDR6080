

<div class="blockTable">
	<div id="WDSTblCon">
		<div>
			<p class="WDSTitle" style="margin-bottom: 0;">
				<span>请选择想要中继的前端由器</span>
				<input id="wdsRefreshBtn" value="刷新" type="button" class="btnA subBtn" />
			</p>
			<table id="WDSTbl" class="dataGrid"></table>
			<p id="WDSScanFail">扫描不到无线路由器，重试请点击右上角的刷新按钮。</p>
		</div>
		<ul>
			<li class="wzdSubLi">
				<input id="pre" type="button" class="btnL" value="{%btn.preStep%}" />
				<input id="next" type="button" value="{%btn.nextStep%}" />
			</li>
		</ul>
	</div>
</div><script type="text/javascript">var wdsTargetIndex=[],scanRetryCounts=1;function wdsTimeoutHandle(){function f(){showConfirm("连接失败，请确定是否重试？",function(c){!0==c?wdsNextStep():(clearTimeout(getWdsStatusHd),wdsCanceldHandle())})}closeLoading();gWifiSwitchSupport||gCustomWifiSwitchSupport?checkWifiSwitchOff(f):f()}
function wdsNextStep(){var f=function(){var c={wireless:{}},c=BAND_2==gBandNum?{wireless:{wlan_wds_2g:{enable:"0",ssid:""},wlan_wds_5g:{enable:"0",ssid:""}}}:{wireless:{wlan_wds_2g:{enable:"0",ssid:""},wlan_wds_5g_1:{enable:"0",ssid:""},wlan_wds_5g_4:{enable:"0",ssid:""}}},a;for(a in wdsTargetSelFreq)if(wdsTargetSelFreq[a].selected){var b={enable:"1"};b.ssid=gRootAPInfo[a].ssid;b.encryption=gRootAPInfo[a].encryption;"0"!=gRootAPInfo[a].encryption&&(b.key=gRootAPInfo[a].key);c.wireless[gWDSModel[a].set_wds]=
b;gRootAPInfo[a].enable="1"}return c}();showLoading(label.WDSConnecting,function(){wdsCanceldHandle()});$.modify(f,function(c){c=c[ERR_CODE];if(ENONE==c){var a=null;c={wireless:{}};for(var b in wdsTargetSelFreq)wdsTargetSelFreq[b].selected&&(c.wireless[gWDSModel[b].wds_start]={set_ip_immediate:"0"});$.action(c);if(!0==bWirelessLinked){var f=!1,n=1,q=function(){if(3<n&&!1==f){var d="";"1"==gLocalAPInfo[curEqtFreq].encryption&&(d="  无线密码："+gLocalAPInfo[curEqtFreq].key);d="您的设备与路由器的连接已断开，请重新进行无线连接...<br />"+
("无线名称："+gLocalAPInfo[curEqtFreq].ssid+d);f=!0;closeLoading();showLoading(d,void 0,void 0,!1)}$.detect(function(){!1==$.result.timeout&&(clearTimeout(a),closeLoading(),showLoading(label.WDSConnecting),connectingCount=1,getWdsStatusHd=$.setTimeout(wdsStatusHd,100))});n++;a=$.setTimeout(q,2E3)};clearTimeout(a);a=$.setTimeout(q,4E3)}else connectingCount=1,$.setTimeout(wdsStatusHd,5E3)}else errHandle(c)})}
function inputPwdNext(f){for(var c=0;c<f.length;++c){var a=$("#"+f[c]).val(),b;b=0==getCNStrLen(a)?EWLANPWDBLANK:checkWlanPwd(a);if(ENONE!=b){$("#"+f[c]+"Err").removeClass("disNone");switch(b){case EWLANPWDBLANK:$("#"+f[c]+"Err span").text(errStr.wlanPwdNull);break;case EINVWLANPWD:$("#"+f[c]+"Err span").text(errStr.wlanPwdInvalid);break;case EINVPSKLEN:$("#"+f[c]+"Err span").text(errStr.wlanPwdLenValid)}return}$("#"+f[c]+"Err").addClass("disNone");b=f[c].replace(/[^0-9]/ig,"");b==FREQ_BS?BAND_2==
gBandNum?(gRootAPInfo[FREQ_2G].key=a,gRootAPInfo[FREQ_2G].pwdErr=!1,gRootAPInfo[FREQ_2G].encryption=uciWireless.dynOptValue.encryption.on,gRootAPInfo[FREQ_5G].key=a,gRootAPInfo[FREQ_5G].pwdErr=!1,gRootAPInfo[FREQ_5G].encryption=uciWireless.dynOptValue.encryption.on):(gRootAPInfo[FREQ_2G].key=a,gRootAPInfo[FREQ_2G].pwdErr=!1,gRootAPInfo[FREQ_2G].encryption=uciWireless.dynOptValue.encryption.on,gRootAPInfo[FREQ_5G1].key=a,gRootAPInfo[FREQ_5G1].pwdErr=!1,gRootAPInfo[FREQ_5G1].encryption=uciWireless.dynOptValue.encryption.on,
gRootAPInfo[FREQ_5G4].key=a,gRootAPInfo[FREQ_5G4].pwdErr=!1,gRootAPInfo[FREQ_5G4].encryption=uciWireless.dynOptValue.encryption.on):(gRootAPInfo[b].key=a,gRootAPInfo[b].pwdErr=!1,gRootAPInfo[b].encryption=uciWireless.dynOptValue.encryption.on)}wdsNextStep()}
function generatePwdConHTML(){return'<div id="pwdInputCon"><p class="WDSTitle">请输入前端路由的无线密码</p><div id="root0Con" class="disNone"><ul class="inputUl"><li class="inputLi"><label>2.4G频段</label><label id="root0Ssid" class="noteLblWDS"></label></li></ul><ul class="inputUl"><li class="inputLi"><label>无线密码</label><label id="root0PwdLbl" class="noteLblWDS disNone">未加密</label><input id="root0PwdInput" maxLength="63" class="disNone"/></li><li class="errLi disNone" id="root0PwdInputErr"><div class="warnCon"><img src="../web-static/images/routerBg.png" /></div><span class="errMsg"></span></li></ul></div><div id="root1Con" class="disNone"><ul class="inputUl"><li class="inputLi"><label>5G频段</label><label id="root1Ssid" class="noteLblWDS"></label></li></ul><ul class="inputUl"><li class="inputLi"><label>无线密码</label><label id="root1PwdLbl" class="noteLblWDS disNone">未加密</label><input id="root1PwdInput" maxLength="63" class="disNone"/></li><li class="errLi disNone" id="root1PwdInputErr"><div class="warnCon"><img src="../web-static/images/routerBg.png" /></div><span class="errMsg"></span></li></ul></div><div id="root2Con" class="disNone"><ul class="inputUl"><li class="inputLi"><label>5G1频段</label><label id="root2Ssid" class="noteLblWDS"></label></li></ul><ul class="inputUl"><li class="inputLi"><label>无线密码</label><label id="root2PwdLbl" class="noteLblWDS disNone">未加密</label><input id="root2PwdInput" maxLength="63" class="disNone"/></li><li class="errLi disNone" id="root2PwdInputErr"><div class="warnCon"><img src="../web-static/images/routerBg.png" /></div><span class="errMsg"></span></li></ul></div><div id="root3Con" class="disNone"><ul class="inputUl"><li class="inputLi"><label>5G2频段</label><label id="root3Ssid" class="noteLblWDS"></label></li></ul><ul class="inputUl"><li class="inputLi"><label>无线密码</label><label id="root3PwdLbl" class="noteLblWDS disNone">未加密</label><input id="root3PwdInput" maxLength="63" class="disNone"/></li><li class="errLi disNone" id="root3PwdInputErr"><div class="warnCon"><img src="../web-static/images/routerBg.png" /></div><span class="errMsg"></span></li></ul></div><div id="root4Con" class="disNone"><ul class="inputUl"><li class="inputLi"><label>无线名称</label><label id="root4Ssid" class="noteLblWDS"></label></li></ul><ul class="inputUl"><li class="inputLi"><label>无线密码</label><label id="root4PwdLbl" class="noteLblWDS disNone">未加密</label><input id="root4PwdInput" maxLength="63" class="disNone"/></li><li class="errLi disNone" id="root4PwdInputErr"><div class="warnCon"><img src="../web-static/images/routerBg.png" /></div><span class="errMsg"></span></li></ul></div><ul><li class="wzdSubLi"><input id="pwdInputPre" type="button" class="btnL" value="{%btn.preStep%}" /><input id="pwdInputNext" type="button" value="{%btn.nextStep%}" /></li></ul></div>'}
function showInputPwdCon(f){$("#pwdInputCon").remove();$("#WDSTblCon").addClass("disNone");$("#WDSTblCon").after(generatePwdConHTML());var c=[],a;for(a in wdsTargetSelFreq)if(wdsTargetSelFreq[a].selected){var b=a;wdsTargetSelFreq[a].bs&&(b=FREQ_BS);$("#root"+b+"Con").removeClass("disNone");$("#root"+b+"Ssid").text(gRootAPInfo[a].ssid);"0"==gRootAPInfo[a].encryption?$("#root"+b+"PwdLbl").removeClass("disNone"):($("#root"+b+"PwdInput").removeClass("disNone"),c.push("root"+b+"PwdInput"),f&&($("#root"+
b+"PwdInput").val(gRootAPInfo[a].key),gRootAPInfo[a].pwdErr&&($("#root"+b+"PwdInputErr").removeClass("disNone"),$("#root"+b+"PwdInputErr span").text("请输入正确的无线密码"))));if(wdsTargetSelFreq[a].bs)break}$("#pwdInputNext").click(function(){inputPwdNext(c)});$("#pwdInputPre").click(function(){$("#pwdInputCon").remove();$("#WDSTblCon").removeClass("disNone")})}
function init(){function f(d){var a=[],g;tmpApList={};for(var c in h)if(h[c]){g=gWDSModel[c].wlan_scan;var b=tmpApList,e=c;g=d.wireless[g];for(var f=c,l=g.length,p=[],k=0;k<l;k++){var m=k+1;p[k]={};p[k].freq=f;p[k].freqArr=[f];p[k].freqInfo=gFreqInfo[f];p[k].ssid=g[k]["ap_"+m].ssid;p[k].encryption=g[k]["ap_"+m].encryption;p[k].rssi=g[k]["ap_"+m].rssi;p[k].signal=20<=g[k]["ap_"+m].rssi?30<=g[k]["ap_"+m].rssi?50<=g[k]["ap_"+m].rssi?5:4:3:10<=g[k]["ap_"+m].rssi?2:1;switch(parseInt(g[k]["ap_"+m].encryption)){case uciWireless.encryptionType.none:m=
label.wirelessNoSecurity;break;case uciWireless.encryptionType.psk2_psk:m=label.wirelessPsk;break;case uciWireless.encryptionType.wep:m=label.wirelessWep;break;case uciWireless.encryptionType.wpa2_wpa:m=label.wirelessWpa;break;case uciWireless.encryptionType.psk2_sae3:m=label.wirelessWpa2PskWpa3Sae;break;case uciWireless.encryptionType.sae3:m=label.wirelessWpa3Sae;break;case uciWireless.encryptionType.wpa3:m=label.wirelessWpa3Enterprise;break;default:m=label.wirelessUnknow}p[k].authMode=m}b[e]=p;
for(b=0;b<tmpApList[c].length;++b){e=!1;for(g=0;g<a.length;++g)if(a[g].ssid==tmpApList[c][b].ssid&&a[g].encryption==tmpApList[c][b].encryption){e=!0;a[g].rssi=Math.max(a[g].rssi,tmpApList[c][b].rssi);a[g].signal=Math.max(a[g].signal,tmpApList[c][b].signal);-1==$.inArray(tmpApList[c][b].freq,a[g].freqArr)&&(a[g].freqArr.push(tmpApList[c][b].freq),a[g].freqInfo=a[g].freqInfo+" & "+tmpApList[c][b].freqInfo,a[g].freq=FREQ_BS);break}e||a.push(tmpApList[c][b])}}return a}function c(){var a={wireless:{table:[]}},
c;for(c in h)h[c]&&a.wireless.table.push(gWDSModel[c].wlan_scan);$.query(a,function(a){closeLoading();ENONE==a[ERR_CODE]?(d=f(a),d.sort(function(a,c){var e=parseInt(a.rssi),g=parseInt(c.rssi);return e>g?1:e==g?0:-1}),d=d.slice(-n),0==d.length?$("#WDSScanFail").css("display","block"):$("#WDSScanFail").css("display","none"),disableBtn("next",!0),wdsTargetIndex=[],wdsTargetSelFreq={}):(d=[],d.length=0,$("#WDSScanFail").css("display","block"),errHandle(a[ERR_CODE]));s.setDataSource(d);s.refresh(1)})}
function a(){if(6<=scanRetryCounts)c();else{var b={wireless:{name:[]}},d;for(d in h)h[d]&&b.wireless.name.push(gWDSModel[d].wlan_scan_status);$.query(b,function(g){var b=!0,d;for(d in g.wireless)1!=g.wireless[d].status&&(b=!1);!0==b?c():(scanRetryCounts++,q=$.setTimeout(a,2E3))})}}function b(){l[FREQ_2G]=!1;l[FREQ_5G]=!1;l[FREQ_5G1]=!1;l[FREQ_5G4]=!1;showLoading(statusStr.wifiScaning,function(){clearTimeout(q);$("#WDSScanFail").css("display","block");d=[];s.setDataSource(d);s.refresh(1)});for(var c in h)h[c]&&
$.action(gWDSModel[c].scan_start);scanRetryCounts=1;q=$.setTimeout(a,3E3)}function t(){if(0==wdsTargetIndex.length)showAlert(errStr.WDSNOHostErr);else{var a=!1,c;for(c in wdsTargetSelFreq)if(wdsTargetSelFreq[c].selected&&"0"!=gRootAPInfo[c].encryption){a=!0;break}a?showInputPwdCon(!1):wdsNextStep()}}var n,q=null,d=[],s=new DataGrid,l={},h=[];h[FREQ_2G]=!1;h[FREQ_5G]=!1;h[FREQ_5G1]=!1;h[FREQ_5G4]=!1;l[FREQ_2G]=!1;l[FREQ_5G]=!1;l[FREQ_5G1]=!1;l[FREQ_5G4]=!1;switch(gBandNum){case BAND_3:n=192;break;
case BAND_2:n=128;break;default:n=64}if(gSupportBS&&"1"==gLocalAPInfo[FREQ_BS].bs_enable){if("1"==gLocalAPInfo[FREQ_BS].wifi_enable)for(var r in gKeyNames[gBandNum].wlan_wds)null!=gKeyNames[gBandNum].wlan_wds[r]&&(h[r]=!0)}else for(r in gLocalAPInfo)FREQ_BS!=r&&(h[r]="1"==gLocalAPInfo[r].enable);$("#pre").click(function(){gIsWifiCfgBsChged=gIsWifiCfg5G4Chged=gIsWifiCfg5GChged=gIsWifiCfg2GChged=gIsWifiCfgChged=!1;loadPage("WizardNetwork.htm","wizardCon")});$("#next").click(function(){gWifiSwitchSupport||
gCustomWifiSwitchSupport?checkWifiSwitchOff(t):t()});$("#wdsRefreshBtn").click(b);disableBtn("next",!0);$("#WDSCon").css({visibility:"visible"});s.init({id:"WDSTbl",data:d,classCol:{gridClassName:"dataGrid",ListSpanClassName:"ListSpan1"},head:[{field:label.select,width:40},{field:label.wirelessNa,width:163},{field:label.sigDep,width:63},{field:"频段信息",width:100},{field:label.secInfo,width:123}],list:[{className:"checkboxBtn",classNameUn:"checkboxBtnUn",classNameDis:"checkboxBtnDis",type:"btn",subType:"checkbox",
click:function(a,c){closeAlertC();var b=d[a].freq,f=d[a].freqArr;if("checkboxBtn"==c.obj.className){var h=d[a].encryption;if(b==FREQ_BS)for(var e=0;e<f.length;e++)l[f[e]]=!0;else l[b]=!0;if(h!=uciWireless.encryptionType.none&&h!=uciWireless.encryptionType.psk2_psk&&h!=uciWireless.encryptionType.psk2_sae3&&h!=uciWireless.encryptionType.sae3&&h!=uciWireless.encryptionType.wpa3)showAlert("所选的路由器加密方式过旧，请将该路由器的加密方式更改为WPA/WPA2-PSK AES或WPA2-PSK/WPA3-SAE后重新连接。"),c.obj.className="checkboxBtnUn";else{for(e=
0;e<d.length;e++)if(e!=a&&"checkboxBtn"!=$("#WDSTbl input")[d.length-1-e].className)if(d[e].freq==FREQ_BS)for(var n=0;n<d[e].freqArr.length;n++){if(l[d[e].freqArr[n]]){$("#WDSTbl input")[d.length-1-e].className="checkboxBtnDis";break}}else l[d[e].freq]&&($("#WDSTbl input")[d.length-1-e].className="checkboxBtnDis");disableBtn("next",!1);wdsTargetIndex.push(a);if(b==FREQ_BS)for(e=0;e<f.length;++e)wdsTargetSelFreq[f[e]]={selected:!0,bs:!0},gRootAPInfo[f[e]].ssid=d[a].ssid,gRootAPInfo[f[e]].encryption=
parseInt(h);else wdsTargetSelFreq[b]={selected:!0,bs:!1},gRootAPInfo[b].ssid=d[a].ssid,gRootAPInfo[b].encryption=parseInt(h)}}else{if(b==FREQ_BS)for(e=0;e<f.length;e++)l[f[e]]=!1;else l[b]=!1;if(b==FREQ_BS)for(e=0;e<f.length;++e)wdsTargetSelFreq[e]={selected:!1,bs:!1};else wdsTargetSelFreq[b]={selected:!1,bs:!1};wdsTargetIndex.splice($.inArray(a,wdsTargetIndex),1);if(0==wdsTargetIndex.length)disableBtn("next",!0),$("#WDSTbl input.checkboxBtnDis").attr("class","checkboxBtnUn");else for(e=0;e<d.length;e++)if(d[e].freq==
FREQ_BS){b=!0;for(n=0;n<d[e].freqArr.length;n++)if(l[d[e].freqArr[n]]){b=!1;break}b&&($("#WDSTbl input")[d.length-1-e].className="checkboxBtnUn")}else l[d[e].freq]||($("#WDSTbl input")[d.length-1-e].className="checkboxBtnUn")}}},{name:"ssid",maxSize:30},{name:"signal",type:"signal"},{name:"freqInfo",maxSize:24},{name:"authMode",maxSize:64}],checkIndex:1,paging:{num:10,page:1},hasSelBox:!1,max:n,edit:!1});b()}init();
</script><style type="text/css">#WDSTblCon{padding:0 120px}#WDSTbl{margin-top:25px!important}#WDSCon{visibility:hidden}#WDSScanFail{line-height:30px;color:#fff;background-color:transparent;border-width:0 1px 1px 1px;border-style:solid;border-color:#1e96d4;text-align:center;display:none}#wdsRefreshBtn{float:right}table.dataGrid td{font-size:14px;height:34px}table.dataGrid tr{background:transparent;border-bottom:1px solid #248ab3}div.pageListPo{margin-bottom:0!important}div.pageListPo span.listSpanS{color:#fff}div.pageListPo span.ListSpan1{color:#248ab3}i.signalCon{width:23px;height:13px;display:inline-block;text-align:left;vertical-align:middle;background:url(../web-static/images/wdsWizardNoneSignal.png) no-repeat;position:relative}i.signalCon i.signal{height:100%;display:inline-block;background:url(../web-static/images/wdsWizardSignal.png) no-repeat;position:absolute}input.checkboxBtn{height:13px;width:13px;border:0;font-size:0;cursor:pointer;outline:0;vertical-align:middle;background:url(../web-static/images/WhiteCheckboxChecked.png) no-repeat}input.checkboxBtnUn{height:13px;width:13px;border:0;font-size:0;cursor:pointer;outline:0;vertical-align:middle;background:url(../web-static/images/WhiteCheckboxUncheck.png) no-repeat}input.checkboxBtnDis{height:11px;width:11px;border:0;font-size:0;cursor:pointer;outline:0;vertical-align:middle;background:url(../web-static/images/WhiteCheckboxDisabled.png) no-repeat}</style>